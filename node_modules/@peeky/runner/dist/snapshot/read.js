import vm from 'vm';
import fs from 'fs-extra';
import { generateSnapshotId, resolveSnapshotPath } from './util.js';
export async function readSnapshots(testFile) {
    const file = resolveSnapshotPath(testFile);
    if (!fs.existsSync(file)) {
        return [];
    }
    const content = await fs.readFile(file, 'utf8');
    const exports = {};
    const context = {
        exports,
    };
    const fn = vm.runInThisContext(`(${Object.keys(context).join(',')}) => { ${content}\n }`, {
        filename: file,
    });
    fn(...Object.values(context));
    return Object.keys(exports).map(title => ({
        id: generateSnapshotId(testFile, title),
        title,
        testFile,
        content: exports[title],
    }));
}
